services:
  docker:
    image: docker.io/docker:dind
    hostname: docker
    privileged: true
    restart: unless-stopped
    command: [
      'dockerd', '--tls=false', '--storage-driver=overlay2',
      '-H', 'tcp://0.0.0.0:2375',
      '-H', 'unix:///var/run/docker/docker.sock'
    ]
    healthcheck:
      test: [
        "CMD-SHELL",
        "docker -H tcp://docker:2375 info",
        "&&",
        "test -S /var/run/docker/docker.sock"
      ]
      interval: 3s
      timeout: 2s
      retries: 10
    volumes:
      - type: bind
        source: /media/usb/ci-docker/run
        target: /var/run/docker
      - type: bind
        source: /media/usb/ci-docker/lib
        target: /var/lib/docker
  gitlab:
    image: docker.io/ravermeister/ci-runner
    hostname: gitlab
    restart: unless-stopped
    depends_on:
      docker:
        condition: service_healthy
    environment:
      CI_RUNNER: gitlab
    command:
      - "run"
      - "--config"
      - "/etc/gitlab-runner/config.toml"
      - "--working-directory"
      - "/opt/gitlab"
    volumes:
      - /etc/ci-runner/gitlab/:/etc/gitlab-runner
      - type: bind
        source: /media/usb/ci-runner/gitlab/home
        target: /opt/gitlab
      - type: bind
        source: /media/usb/ci-runner/gitlab/cache
        target: /opt/cache
  forgejo:
    image: docker.io/ravermeister/ci-runner
    hostname: forgejo
    restart: unless-stopped
    depends_on:
      docker:
        condition: service_healthy
    environment:
      CI_RUNNER: forgejo
    command:
      - "-c"
      - "/etc/forgejo.yml"
      - "daemon"
    volumes:
      - /etc/ci-runner/forgejo/runner.cfg:/root/.runner
      - /etc/ci-runner/forgejo/config.yml:/etc/forgejo.yml
      - type: bind
        source: /media/usb/ci-runner/forgejo/cache
        target: /root/.cache/actcache
      - type: bind
        source: /media/usb/ci-runner/forgejo/host
        target: /root/.cache/act
      - type: bind
        source: /media/usb/ci-runner/forgejo/docker
        target: /workspace
  woodpecker:
    image: docker.io/ravermeister/ci-runner
    hostname: woodpecker
    restart: unless-stopped
    # FIXME: on some docker setups this is required (armbian, but not raspbian)
    #        why and how can we get rid of ths?
    network_mode: bridge
    depends_on:
      docker:
        condition: service_healthy
    environment:
      CI_RUNNER: woodpecker
      DOCKER_HOST: unix:///var/run/docker/docker.sock
      WOODPECKER_SERVER: woodpecker-grpc.codeberg.org
      WOODPECKER_AGENT_SECRET_FILE: /etc/woodpecker/codeberg.secret
      WOODPECKER_GRPC_SECURE: true
      WOODPECKER_HEALTHCHECK: false
      WOODPECKER_BACKEND: docker
      WOODPECKER_HOSTNAME: woodpecker
      WOODPECKER_AGENT_LABELS: owner=raver
      WOODPECKER_MAX_WORKFLOWS: 2
    volumes:
      - /etc/ci-runner/woodpecker:/etc/woodpecker
      - /media/usb/ci-docker/run:/var/run/docker
      - /media/usb/ci-runner/woodpecker/tmp:/root/woodpecker/tmp